<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<<<<<<< HEAD
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Injera Be Wat — Prototype (Visual Layered)</title>

<style>
/* =========================
   BASE GAME STYLES (SAFE)
========================= */
:root{
  --bg:#071018;
  --panel:rgba(10,18,30,.78);
  --panel2:rgba(9,16,26,.60);
  --border:rgba(255,255,255,.10);
  --text:#eaf3ff;
  --muted:#b9c7e8;

  --eth-green:#0f7a3a;
  --eth-yellow:#ffd166;
  --eth-red:#d62828;
  --eth-blue:#1d4ed8;
  --gold:#f7d36a;

<<<<<<< HEAD
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --r:18px;
}
=======
      --good:#7cffb2;
      --bad:#ff6fb1;
      --warn:#ffd166;

      --good:#7cffb2;
      --bad:#ff6fb1;
      --warn:#ffd166;
=======
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Injera Be Wat — Prototype</title>

<style>
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:#0b0f14;
    color:#eaf0ff;
    padding:20px;
  }

  h1{margin:0 0 6px}
  .sub{color:#b6c2e3;margin-bottom:16px}
>>>>>>> parent of 2241160 (Fix setup Joker redraw + add end-game scoring)

  .board{
    display:flex;
    gap:24px;
    flex-wrap:wrap;
  }

<<<<<<< HEAD
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 18px;
    }
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:#02040a;
  min-height:100vh;
  padding:22px;
}

header{
  padding:18px 20px;
  border-radius:22px;
  border:1px solid var(--border);
}

/* =========================
   CLASSROOM VISUAL LAYER
   (PASTE BELOW BASE CSS)
========================= */

/* Desk + classroom light */
body{
  background:
    radial-gradient(900px 500px at 15% 10%, rgba(255,255,255,.18), transparent 60%),
    radial-gradient(900px 500px at 85% 12%, rgba(255,255,255,.12), transparent 60%),
    radial-gradient(1200px 700px at 50% 35%, rgba(255,255,255,.06), transparent 65%),
    repeating-linear-gradient(
      90deg,
      rgba(150,90,35,.22) 0px,
      rgba(150,90,35,.22) 14px,
      rgba(120,70,25,.22) 14px,
      rgba(120,70,25,.22) 28px
    ),
    linear-gradient(180deg, #2b3a4a 0%, #1b2430 35%, #6a3c18 100%);
}

<<<<<<< HEAD
/* Chalkboard header */
header{
  position:relative;
  background:
    radial-gradient(700px 260px at 20% 30%, rgba(255,255,255,.08), transparent 60%),
    radial-gradient(700px 260px at 80% 35%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(135deg, rgba(10,60,45,.92), rgba(7,32,26,.92));
  box-shadow:0 22px 80px rgba(0,0,0,.55);
}
=======
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(0,0,0,.18);
      font-size:13px;
      white-space:nowrap;
    }
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)
=======
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)
=======
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)

header:after{
  content:"";
  position:absolute;
  left:18px; right:18px; bottom:-10px;
  height:16px;
  border-radius:0 0 18px 18px;
  background:linear-gradient(180deg, rgba(210,160,95,.55), rgba(140,90,40,.55));
}

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
/* Worksheet picked area */
.pickedSlot{
  background:
    repeating-linear-gradient(
      180deg,
      rgba(70,130,180,.16) 0px,
      rgba(70,130,180,.16) 2px,
      rgba(255,255,255,.06) 2px,
      rgba(255,255,255,.06) 28px
    ),
    rgba(0,0,0,.10);
}

/* Picked card emphasis */
.pickedSlot .card{
  transform:scale(1.25);
  outline:3px solid rgba(255,209,102,.55);
}
</style>
</head>

<body>
  <header>
    <h1>Injera Be Wat</h1>
    <div class="sub">Visual layer applied safely. Game logic untouched.</div>
  </header>
=======
=======
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)
=======
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)
    /* Ethiopian holiday “deck” / circle button */
    .circleBtn{
      width:160px;height:210px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), transparent 40%),
        linear-gradient(90deg, rgba(15,122,58,.85), rgba(255,209,102,.85), rgba(214,40,40,.85));
      transition: transform .12s ease;
      user-select:none;
    }
    .circleBtn:before{
      content:"";
      position:absolute;inset:-40px;
      background:
        radial-gradient(circle at 30% 30%, rgba(247,211,106,.55), transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(29,78,216,.45), transparent 65%);
      transform: rotate(12deg);
      opacity:.85;
    }
    .circleBtn:after{
      content:"";
      position:absolute;inset:12px;
      border-radius:18px;
      border:2px solid rgba(255,255,255,.22);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.15);
    }
    .circleBtn .label{
      position:absolute;left:0;right:0;top:0;bottom:0;
      display:grid;
      place-items:center;
      font-weight:900;
      letter-spacing:1px;
      font-size:24px;
      text-transform:uppercase;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }
    .circleBtn .mini{
      position:absolute;left:12px;top:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      font-size:12px;color:var(--muted);
    }
    .circleBtn.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.2)}
    .circleBtn:hover:not(.disabled){transform: translateY(-1px);}
=======
  .left{
    flex:1;
    min-width:320px;
  }

  .right{
    width:300px;
  }

  .zoneTitle{
    font-weight:900;
    margin:12px 0 8px;
  }

  .circleBtn{
    width:140px;
    height:190px;
    border-radius:18px;
    background:#1f2937;
    display:grid;
    place-items:center;
    cursor:pointer;
    font-weight:900;
    letter-spacing:1px;
    border:2px solid #334155;
  }

  .circleBtn.disabled{
    opacity:.4;
    cursor:not-allowed;
  }

  .pickedSlot{
    width:100px;
    height:140px;
    border:2px dashed #334155;
    display:grid;
    place-items:center;
    margin-bottom:10px;
  }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .card{
    width:80px;
    height:110px;
    border-radius:12px;
    background:#f9fafb;
    color:#0b1220;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.4);
  }
>>>>>>> parent of 2241160 (Fix setup Joker redraw + add end-game scoring)

  .card.selected{
    outline:4px solid #facc15;
    transform:translateY(-2px);
  }

  button{
    margin-top:8px;
    padding:8px 10px;
    font-weight:800;
    cursor:pointer;
  }

  button:disabled{
    opacity:.4;
    cursor:not-allowed;
  }

  .log{
    background:#020617;
    border:1px solid #334155;
    padding:10px;
    height:260px;
    overflow:auto;
    font-size:13px;
  }

  .log div{margin-bottom:6px}
</style>
</head>

<body>

<h1>Injera Be Wat</h1>
<div class="sub">
Pick from the Circle. Add or Match from the Middle. Capture as much as you can before ending your turn.
</div>

<div class="board">
  <div class="left">

    <div class="zoneTitle">Circle</div>
    <div id="circleBtn" class="circleBtn">PICK</div>

    <div class="zoneTitle">Picked</div>
    <div id="pickedSlot" class="pickedSlot">—</div>

    <button id="btnMatch" disabled>MATCH</button>
    <button id="btnAdd" disabled>ADD</button>
    <button id="btnClear" disabled>CLEAR</button>
    <button id="btnEnd">END TURN</button>

    <div class="zoneTitle">Middle</div>
    <div id="middleRow" class="row"></div>
  </div>

  <div class="right">
    <div class="zoneTitle">Log</div>
    <div id="log" class="log"></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

let deck = [];
let middle = [];
let picked = null;
let selected = new Set();
let capturedThisTurn = false;

function log(msg){
  const d = document.createElement("div");
  d.innerHTML = msg;
  $("log").prepend(d);
}

function newDeck(){
  const d=[];
  for(let i=1;i<=10;i++){
    for(let j=0;j<4;j++) d.push(i);
  }
  d.push("JOKER","JOKER");
  return d.sort(()=>Math.random()-.5);
}

function start(){
  deck = newDeck();
  middle = [deck.pop(), deck.pop(), deck.pop()];
  picked = null;
  selected.clear();
  log("New game started.");
  render();
}

function render(){
  $("circleBtn").classList.toggle("disabled", !!picked);
  $("pickedSlot").innerHTML = picked ?? "—";

  const mid = $("middleRow");
  mid.innerHTML="";
  middle.forEach((v,i)=>{
    const c=document.createElement("div");
    c.className="card"+(selected.has(i)?" selected":"");
    c.textContent=v;
    c.onclick=()=>{
      if(!picked) return;
      selected.has(i)?selected.delete(i):selected.add(i);
      updateButtons();
      render();
    };
    mid.appendChild(c);
  });

  updateButtons();
}

function updateButtons(){
  $("btnClear").disabled = selected.size===0;
  $("btnMatch").disabled = !picked || selected.size===0;
  $("btnAdd").disabled = !picked || selected.size<2 || typeof picked!=="number";
}

$("circleBtn").onclick=()=>{
  if(picked || deck.length===0) return;
  picked = deck.pop();
  selected.clear();
  capturedThisTurn=false;

  if(picked==="JOKER"){
    middle=[];
    picked=null;
    log("JOKER! Middle cleared.");
    return;
  }

  log("Picked "+picked);
  render();
};

$("btnClear").onclick=()=>{
  selected.clear();
  render();
};

$("btnMatch").onclick=()=>{
  const sel=[...selected];
  if(sel.every(i=>middle[i]===picked)){
    sel.sort((a,b)=>b-a).forEach(i=>middle.splice(i,1));
    selected.clear();
    capturedThisTurn=true;
    log("MATCH captured.");
    render();
  }else{
    log("MATCH failed.");
  }
};

$("btnAdd").onclick=()=>{
  const sum=[...selected].reduce((a,i)=>a+middle[i],0);
  if(sum===picked){
    [...selected].sort((a,b)=>b-a).forEach(i=>middle.splice(i,1));
    selected.clear();
    capturedThisTurn=true;
    log("ADD captured.");
    render();
  }else{
    log("ADD failed.");
  }
};

$("btnEnd").onclick=()=>{
  if(!picked) return;
  if(!capturedThisTurn){
    middle.push(picked);
    log("No capture. Card goes to middle.");
  }
  picked=null;
  selected.clear();
  render();
};

start();
</script>

<<<<<<< HEAD
    // ===== Setup Joker rule helpers =====
    function putBackJokerRandomly(card){
      const pos = Math.floor(Math.random() * (state.deck.length + 1));
      state.deck.splice(pos, 0, card);
    }

    function drawNonJokerFromCircleForSetup(){
      // Try a few times in case jokers pop repeatedly
      for(let tries=0; tries<20; tries++){
        if(state.deck.length===0) return null;
        const c = state.deck.pop();
        if(c.type === "joker"){
          putBackJokerRandomly(c);
          logMsg(`⚠️ Joker drawn during setup — put back into the Circle randomly. Draw again.`);
          continue;
        }
        return c;
      }
      // Safety fallback
      return state.deck.pop() || null;
    }

    // ========= Rendering =========
    function cardClass(card){
      if(card.type==="joker") return "card joker";
      if(card.type==="face") return "card face";
      return "card";
    }

    function cardLabel(card){
      if(card.type==="joker") return "JOKER";
      return `${card.rank}${card.suit}`;
    }

    function renderCard(card, {selected=false}={}){
      const div = document.createElement("div");
      div.className = cardClass(card) + (selected ? " selected" : "");
      div.dataset.id = card.id;

      const rank = document.createElement("div");
      rank.className = "rank";
      rank.textContent = (card.type==="joker") ? "★" : (card.rank);
      div.appendChild(rank);

      const corner = document.createElement("div");
      corner.className = "corner";
      corner.textContent = (card.type==="joker") ? "JOKER" : card.suit;
      div.appendChild(corner);

      return div;
    }

    function selectedCards(){
      return state.middle.filter(c=>state.selectedIds.has(c.id));
    }

    function updateSelectionUI(){
      const sel = selectedCards();
      const sum = sel.reduce((a,c)=>a+addValue(c),0);
      $("selSum").textContent = sum;

      const hasPicked = !!state.picked;
      const hasSelection = sel.length>0;
      const inPlay = state.phase === "play";

      $("btnClear").disabled = !(inPlay && hasPicked && hasSelection);
      $("btnMatch").disabled = !(inPlay && hasPicked && hasSelection);

      const canAdd = inPlay && hasPicked && isNumericCard(state.picked) && sel.length>=2;
      $("btnAdd").disabled = !canAdd;

      $("btnEnd").disabled = !inPlay;

      const endGameAllowed = (state.finalDrawnBy !== null) && inPlay && !state.picked;
      $("btnEndGame").disabled = !endGameAllowed;
    }

    function render(){
      $("turnName").textContent = state.players[state.turn].name;

      const phaseLabel =
        (state.phase==="starter") ? `SETUP: Starter draws (${state.starterRemaining} left)` :
        (state.phase==="seed")    ? `SETUP: Seed Middle (${state.seedRemaining} left)` :
                                   "PLAY";
      $("phaseLabel").textContent = phaseLabel;

      $("deckCount").textContent = state.deck.length;
      $("midCount").textContent = state.middle.length;

      if(state.phase==="starter"){
        $("circleHint").textContent = "Setup: click Circle to draw your starter card (Joker goes back randomly; draw again).";
      } else if(state.phase==="seed"){
        $("circleHint").textContent = "Setup: click Circle to place a card into the Middle (Joker goes back randomly; draw again).";
      } else {
        $("circleHint").textContent = (state.deck.length===0)
          ? "Circle is empty. Finish the last turn, then END GAME."
          : "Click the Circle to draw 1 card.";
      }

      const circle = $("circleBtn");
      const circleDisabled =
        (state.phase==="play" && !!state.picked) ||
        (state.deck.length===0);
      circle.classList.toggle("disabled", circleDisabled);

      const slot = $("pickedSlot");
      slot.innerHTML = "";
      if(state.phase==="starter"){
        slot.innerHTML = `<div class="hint"><b>Setup step 1</b><br/>Draw your starter card. Joker goes back randomly.</div>`;
      } else if(state.phase==="seed"){
        slot.innerHTML = `<div class="hint"><b>Setup step 2</b><br/>Seed the Middle with 3 draws. Joker goes back randomly.</div>`;
      } else if(!state.picked){
        slot.innerHTML = `<div class="hint">No picked card yet.</div>`;
      } else {
        slot.appendChild(renderCard(state.picked));
      }

      $("tip").innerHTML =
        (state.phase==="play")
          ? `Tip: You can capture multiple times with the same picked card before END TURN.`
          : `Tip: Setup goes fast — then the real game begins.`;

      const mid = $("middleRow");
      mid.innerHTML = "";
      state.middle.forEach(c=>{
        const node = renderCard(c,{selected: state.selectedIds.has(c.id)});
        node.addEventListener("click", ()=>{
          if(state.phase!=="play") return;
          if(!state.picked) return;
          if(state.selectedIds.has(c.id)) state.selectedIds.delete(c.id);
          else state.selectedIds.add(c.id);
          render();
        });
        mid.appendChild(node);
      });

      const pbox = $("playersBox");
      pbox.innerHTML = "";
      state.players.forEach((p, idx)=>{
        const pts = playerPoints(p);
        const card = document.createElement("div");
        card.className = "stat";
        card.innerHTML = `
          <div class="name">${idx===state.turn ? "▶ " : ""}${p.name}</div>
          <div class="meta">Cards collected: <b>${p.pile.length}</b></div>
          <div class="meta">Points (if ended now): <b>${pts}</b></div>
        `;
        pbox.appendChild(card);
      });

      updateSelectionUI();
    }

    // ========= Log =========
    function logMsg(html){
      const item = document.createElement("div");
      item.className="logItem";
      item.innerHTML = html;
      $("log").prepend(item);
    }
    function logClear(){
      $("log").innerHTML = "";
    }

    // ========= Turn helpers =========
    function currentPlayer(){ return state.players[state.turn]; }
    function advanceTurn(){ state.turn = (state.turn + 1) % state.players.length; }

    // ========= Game Over / Scoring =========
    function computeScores(){
      return state.players.map((p, idx)=>({
        idx,
        name: p.name,
        cards: p.pile.length,
        points: playerPoints(p)
      })).sort((a,b)=> b.points - a.points);
    }

    function openScoreModal(){
      const scores = computeScores();
      const best = scores[0];
      const tied = scores.filter(s=> s.points === best.points);

      $("winnerLine").textContent =
        (tied.length > 1)
          ? `It’s a tie! (${tied.map(x=>x.name).join(" & ")}) — ${best.points} points`
          : `${best.name} wins with ${best.points} points!`;

      const board = $("scoreBoard");
      board.innerHTML = "";
      scores.forEach((s,i)=>{
        const row = document.createElement("div");
        row.className = "scoreRow" + (s.points===best.points ? " winner" : "");
        row.innerHTML = `
          <div class="scoreLeft">${i+1}. ${s.name}</div>
          <div class="scoreRight">Cards: <b>${s.cards}</b> &nbsp;•&nbsp; Points: <b>${s.points}</b></div>
        `;
        board.appendChild(row);
      });

      $("scoreRulesNote").innerHTML =
        `Scoring (end only): 1–10 = 1 point each • J/Q/K = 10 points each • Joker = 1 point`;

      $("scoreModal").classList.add("show");
    }
    function closeScoreModal(){ $("scoreModal").classList.remove("show"); }

    function endGame(){
      if(state.phase!=="play"){
        logMsg(`You can’t end the game during setup.`);
        return;
      }
      if(state.finalDrawnBy === null){
        logMsg(`The Circle isn’t empty yet. Game ends when the last Circle card is picked.`);
        return;
      }
      if(state.picked){
        logMsg(`Finish the last turn first (END TURN), then END GAME.`);
        return;
      }

      if(state.middle.length > 0){
        const taker = state.players[state.finalDrawnBy];
        const taken = state.middle.length;
        taker.pile.push(...state.middle);
        state.middle = [];
        logMsg(`<strong>End rule:</strong> <strong>${taker.name}</strong> was the last to pick from the Circle, so they collect the remaining Middle cards (<b>${taken}</b>).`);
      }

      logMsg(`<strong>Game over.</strong> Final scoring complete.`);
      render();
      openScoreModal();
    }

    // ========= Actions =========
    function drawCard(){
      if(state.deck.length===0){
        logMsg(`<strong>Circle is empty.</strong> Finish the last turn, then END GAME.`);
        render();
        return;
      }

      // SETUP: starter draws (joker goes back randomly; same player draws again)
      if(state.phase==="starter"){
        const p = currentPlayer();
        const c = drawNonJokerFromCircleForSetup();
        if(!c){
          logMsg(`<strong>Circle is empty during setup.</strong>`);
          render();
          return;
        }

        p.pile.push(c);
        logMsg(`<strong>${p.name}</strong> draws starter card <strong>${cardLabel(c)}</strong> (auto-banked).`);

        state.starterRemaining -= 1;

        if(state.starterRemaining > 0){
          advanceTurn();
        } else {
          state.phase = "seed";
          state.turn = 0;
          logMsg(`<strong>Setup step 2:</strong> Seed the Middle with <strong>3 draws</strong> (players take turns). Joker goes back randomly.`);
        }

        render();
        return;
      }

      // SETUP: seed middle (joker goes back randomly; same player draws again)
      if(state.phase==="seed"){
        const p = currentPlayer();
        const c = drawNonJokerFromCircleForSetup();
        if(!c){
          logMsg(`<strong>Circle is empty during setup.</strong>`);
          render();
          return;
        }

        state.middle.push(c);
        logMsg(`<strong>${p.name}</strong> seeds the Middle with <strong>${cardLabel(c)}</strong>.`);

        state.seedRemaining -= 1;

        if(state.seedRemaining > 0){
          advanceTurn();
        } else {
          state.phase = "play";
          state.turn = 0;
          logMsg(`<strong>Setup complete.</strong> Normal play begins. <strong>${currentPlayer().name}</strong> goes first.`);
        }

        render();
        return;
      }

      // PLAY: draw 1 card
      if(state.phase==="play"){
        if(state.picked) return;

        const c = state.deck.pop();
        state.picked = c;
        state.selectedIds.clear();
        state.capturedThisTurn = false;

        if(state.deck.length === 0){
          state.finalDrawnBy = state.turn;
          logMsg(`<strong>Last card picked from the Circle!</strong> Finish this turn. Then click <b>END GAME</b>.`);
        }

        if(c.type==="joker"){
          const taker = currentPlayer();
          let taken = 0;

          taken += state.middle.length;
          taker.pile.push(...state.middle);
          state.middle = [];

          state.players.forEach(p=>{
            if(p!==taker){
              taken += p.pile.length;
              taker.pile.push(...p.pile);
              p.pile = [];
            }
          });

          taker.pile.push(c);
          state.picked = null;

          logMsg(`<strong>${taker.name}</strong> drew a <strong>JOKER</strong> and collected <strong>everything</strong> (taken cards: <b>${taken}</b> + Joker). Turn ends.`);
          advanceTurn();
          render();
          return;
        }

        logMsg(`<strong>${currentPlayer().name}</strong> picked <strong>${cardLabel(state.picked)}</strong>. Select Middle cards, then CAPTURE.`);
        render();
        return;
      }
    }

    function clearSelection(){
      state.selectedIds.clear();
      render();
    }

    function captureMatch(){
      if(state.phase!=="play") return;
      if(!state.picked) return;

      const sel = selectedCards();
      if(sel.length===0){
        logMsg(`Select at least 1 Middle card for MATCH.`);
        return;
      }

      const ok = sel.every(c=> c.rank === state.picked.rank);
      if(!ok){
        logMsg(`❌ MATCH failed. Selected cards must all match the picked rank (<strong>${state.picked.rank}</strong>).`);
        return;
      }

      state.middle = state.middle.filter(c=> !state.selectedIds.has(c.id));
      currentPlayer().pile.push(...sel);
      state.selectedIds.clear();
      state.capturedThisTurn = true;

      logMsg(`✅ <strong>${currentPlayer().name}</strong> MATCH captured <b>${sel.length}</b> card(s). You can capture again with the same picked card.`);
      render();
    }

    function captureAdd(){
      if(state.phase!=="play") return;
      if(!state.picked) return;

      if(!isNumericCard(state.picked)){
        logMsg(`ADD only works when the picked card is A or 2–10.`);
        return;
      }

      const sel = selectedCards();
      if(sel.length < 2){
        logMsg(`Select <strong>2 or more</strong> Middle cards to ADD.`);
        return;
      }

      const target = addValue(state.picked);
      const sum = sel.reduce((a,c)=>a+addValue(c),0);

      if(sum !== target){
        logMsg(`❌ ADD failed. Selected sum is <b>${sum}</b> but picked is <b>${target}</b>.`);
        return;
      }

      state.middle = state.middle.filter(c=> !state.selectedIds.has(c.id));
      currentPlayer().pile.push(...sel);
      state.selectedIds.clear();
      state.capturedThisTurn = true;

      logMsg(`✅ <strong>${currentPlayer().name}</strong> ADD captured <b>${sel.length}</b> card(s) (sum ${sum}). You can capture again with the same picked card.`);
      render();
    }

    function endTurn(){
      if(state.phase!=="play"){
        logMsg(`During setup, just click PICK.`);
        return;
      }

      if(!state.picked){
        logMsg(`Pick a card first.`);
        return;
      }

      const p = currentPlayer();

      if(state.capturedThisTurn){
        p.pile.push(state.picked);
        logMsg(`<strong>${p.name}</strong> ends turn and banks picked card <strong>${cardLabel(state.picked)}</strong>.`);
      } else {
        state.middle.push(state.picked);
        logMsg(`<strong>${p.name}</strong> could not play <strong>${cardLabel(state.picked)}</strong>, so it goes to the Middle.`);
      }

      state.picked = null;
      state.selectedIds.clear();
      state.capturedThisTurn = false;

      advanceTurn();
      render();
    }

    // ========= Wire up =========
    $("circleBtn").addEventListener("click", ()=>{
      if($("circleBtn").classList.contains("disabled")) return;
      drawCard();
    });
    $("btnClear").addEventListener("click", clearSelection);
    $("btnMatch").addEventListener("click", captureMatch);
    $("btnAdd").addEventListener("click", captureAdd);
    $("btnEnd").addEventListener("click", endTurn);
    $("btnEndGame").addEventListener("click", endGame);

    $("btnNew").addEventListener("click", ()=>{
      $("startModal").classList.add("show");
    });

    // ========= Start modal =========
    function closeModal(){ $("startModal").classList.remove("show"); }
    $("btnCloseModal").addEventListener("click", closeModal);

    $("btnResetDefaults").addEventListener("click", ()=>{
      $("name1").value = "";
      $("name2").value = "";
      $("name3").value = "";
    });

    $("playerCount").addEventListener("change", ()=>{
      const count = Number($("playerCount").value);
      $("name3").disabled = (count !== 3);
      if(count !== 3) $("name3").value = "";
    });

    $("btnStartGame").addEventListener("click", ()=>{
      const count = Number($("playerCount").value);
      const names = [
        $("name1").value.trim(),
        $("name2").value.trim(),
        $("name3").value.trim(),
      ];
      resetGame(count, names);
      closeModal();
    });

    // ========= Score modal =========
    $("btnCloseScore").addEventListener("click", closeScoreModal);
    $("btnNewFromScore").addEventListener("click", ()=>{
      closeScoreModal();
      $("startModal").classList.add("show");
    });

    // Start
    resetGame(3, ["Player 1","Player 2","Player 3"]);
  </script>
>>>>>>> parent of 6fe9553 (Baseline: gameplay stable with chain captures and setup rules)
=======
>>>>>>> parent of 2241160 (Fix setup Joker redraw + add end-game scoring)
</body>
</html>